<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoker Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --bg-dark: #070d18;
    --bg-darker: #050a14;
    --primary: #2563eb;
    --accent: #facc15;
    --white: #ffffff;
    --glass: rgba(255, 255, 255, 0.06);
    --border: rgba(255, 255, 255, 0.12);
    --text-secondary: rgba(255, 255, 255, 0.7);
    --success: #22c55e;
    --error: #dc2626;
}

/* Light Mode Overrides */
body.light-mode {
    --bg-dark: #f8fafc;
    --bg-darker: #e2e8f0;
    --primary: #2563eb;
    --accent: #f59e0b;
    --glass: rgba(255, 255, 255, 0.8);
    --border: rgba(0, 0, 0, 0.1);
    --text-secondary: rgba(0, 0, 0, 0.6);
    --success: #16a34a;
    --error: #dc2626;
    background: var(--bg-dark);
    color: #0f172a;
}

body.light-mode .card {
    background: var(--glass);
    border-color: var(--border);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

body.light-mode table th {
    background: rgba(0, 0, 0, 0.05);
}

body.light-mode input,
body.light-mode select,
body.light-mode textarea {
    background: rgba(255, 255, 255, 0.9);
    color: #0f172a;
    border-color: var(--border);
}

body.light-mode .action-btn,
body.light-mode .cta,
body.light-mode .logout-btn {
    color: white;
}

* { box-sizing: border-box; margin:0; padding:0; }

body {
    font-family:'Inter',sans-serif;
    background: var(--bg-dark);
    color: var(--white);
    padding-top: 80px;
    min-height: 100vh;
}

/* Header - Desktop */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 50px;
    background: rgba(5, 10, 20, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.header-left {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
}

header h1 {
    font-size: 26px;
    font-weight: 700;
    margin: 0;
    color: var(--white);
}

#active-supplier {
    font-size: 16px;
    color: var(--accent);
    font-weight: 500;
    background: rgba(250, 204, 21, 0.15);
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid rgba(250, 204, 21, 0.3);
    white-space: nowrap;
}

/* Desktop Navigation */
.desktop-nav {
    display: flex;
    align-items: center;
    gap: 16px;
}

.desktop-nav a,
.desktop-nav button {
    padding: 10px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.desktop-nav .cta {
    background: var(--primary);
    color: white;
}

.desktop-nav .cta:hover {
    background: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}

.desktop-nav .logout-btn {
    background: var(--accent);
    color: #000;
}

.desktop-nav .logout-btn:hover {
    background: #fde047;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(250, 204, 21, 0.4);
}

.desktop-nav .suppliers-btn,
.desktop-nav .customers-btn {
    background: transparent;
    color: var(--white);
    border: 1px solid var(--border);
}

.desktop-nav .suppliers-btn:hover,
.desktop-nav .customers-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--accent);
    color: var(--accent);
}

/* Hamburger - Mobile Only */
.hamburger {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 30px;
    height: 21px;
    cursor: pointer;
    z-index: 101;
}

.hamburger span {
    display: block;
    height: 3px;
    width: 100%;
    background: var(--white);
    border-radius: 3px;
    transition: all 0.3s ease;
}

.hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
.hamburger.active span:nth-child(2) { opacity: 0; }
.hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }

/* Mobile Nav Overlay */
.mobile-nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 32px;
    transform: translateX(100%);
    transition: transform 0.4s ease;
    z-index: 100;
    visibility: hidden;
    pointer-events: none;
}

.mobile-nav.active {
    transform: translateX(0);
    visibility: visible;
    pointer-events: auto;
}

.mobile-nav a,
.mobile-nav button {
    font-size: 24px;
    font-weight: 600;
    color: var(--white);
    background: none;
    border: none;
    padding: 12px 24px;
    width: 80%;
    text-align: center;
    border-radius: 12px;
    cursor: pointer;
}

.mobile-nav a:hover,
.mobile-nav button:hover {
    background: rgba(255, 255, 255, 0.1);
}

.mobile-nav-close {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 32px;
    color: var(--white);
    background: none;
    border: none;
    cursor: pointer;
}

/* Theme Toggle Switch */
.theme-toggle {
    position: relative;
    display: inline-block;
    width: 56px;
    height: 30px;
}

.theme-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #64748b;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #facc15;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider:after {
    content: 'üåô';
    color: white;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    transition: .4s;
}

input:checked + .slider:after {
    content: '‚òÄÔ∏è';
    left: 8px;
    right: auto;
}

.main { max-width: 1200px; margin: 50px auto; padding: 20px; display: flex; flex-direction: column; gap: 40px; }
.card { background: var(--glass); padding: 30px; border-radius: 20px; border: 1px solid var(--border); backdrop-filter: blur(12px); }
.card h2 { margin-bottom: 20px; color: var(--accent); }

/* Analytics */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.metric-card {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    border: 1px solid var(--border);
}

.metric-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.metric-card .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    margin-top: 40px;
}

.chart-container {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid var(--border);
    height: 340px;
    position: relative;
}

.chart-container h3 {
    text-align: center;
    margin-bottom: 16px;
    color: var(--white);
    font-size: 18px;
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}

/* Filters */
.filter-bar {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}

.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.filter-group input,
.filter-group select {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.08);
    color: white;
    font-size: 16px;
}

#clear-filters,
#export-csv-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    align-self: flex-start;
}

#clear-filters {
    background: #6b7280;
}

#export-csv-btn {
    background: var(--success);
    color: white;
}

/* Desktop Table */
.desktop-table-wrapper {
    overflow-x: auto;
    border-radius: 16px;
    border: 1px solid var(--border);
    margin-top: 16px;
    -webkit-overflow-scrolling: touch;
}

.table {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}

.table th {
    background: rgba(255,255,255,0.05);
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Mobile Card List */
.mobile-invoice-list {
    display: none;
    flex-direction: column;
    gap: 16px;
    margin-top: 16px;
}

.invoice-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
}

.invoice-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
}

.invoice-card-main {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 16px;
}

.invoice-card-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 14px;
}

.invoice-card-value {
    color: var(--white);
}

.invoice-card-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    flex-wrap: wrap;
}

.delete-cell-mobile {
    text-align: right;
    margin-top: 12px;
}

.delete-cross {
    font-size: 24px;
    color: var(--error);
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.2s;
    display: inline-block;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-cross:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: scale(1.1);
}

/* Action Buttons */
.action-btn {
    padding: 10px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.action-btn:hover {
    transform: translateY(-2px);
}

.edit-btn {
    background: var(--accent);
    color: #000;
}

.edit-btn:hover {
    background: #fde047;
    box-shadow: 0 6px 20px rgba(250, 204, 21, 0.4);
}

.view-btn {
    background: var(--primary);
    color: white;
}

.view-btn:hover {
    background: #3b82f6;
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}

.download-btn {
    background: var(--success);
    color: white;
}

.download-btn:hover {
    background: #16a34a;
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.actions-cell {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.delete-cell {
    text-align: right;
    width: 40px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    header { padding: 20px; }
    .desktop-nav { display: none; }
    .hamburger { display: flex; }
    .mobile-invoice-list { display: flex; }
    .desktop-table-wrapper { display: none; }
    .main { padding: 20px; }
    .card { padding: 20px; }
    .filter-controls { grid-template-columns: 1fr; }
    .invoice-card-main { grid-template-columns: 1fr; gap: 4px; }
    .invoice-card-actions { flex-direction: column; }
    .action-btn { width: 100%; text-align: center; }
    .actions-cell { flex-direction: column; }
}
</style>
</head>
<body>
<header>
    <div class="header-left">
        <h1>Dashboard</h1>
        <span id="active-supplier"></span>
    </div>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav">
        <button id="create-invoice-btn" class="cta">Create New Invoice</button>
        <a href="suppliers.html" class="suppliers-btn">Suppliers</a>
        <a href="customers.html" class="customers-btn">Customers</a>
        <button id="logout-btn" class="logout-btn">Logout</button>
        <label class="theme-toggle">
            <input type="checkbox" id="theme-toggle-desktop">
            <span class="slider"></span>
        </label>
    </nav>

    <!-- Hamburger Icon (Mobile Only) -->
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-nav" id="mobile-nav">
        <button class="mobile-nav-close" id="mobile-nav-close">√ó</button>
        <button id="mobile-create-invoice-btn" class="cta">Create New Invoice</button>
        <a href="suppliers.html">Suppliers</a>
        <a href="customers.html">Customers</a>
        <button id="mobile-logout-btn">Logout</button>
        <label class="theme-toggle">
            <input type="checkbox" id="theme-toggle-mobile">
            <span class="slider"></span>
        </label>
    </div>
</header>

<div class="main">
    <div class="card">
        <h2>Quick Stats</h2>
        <div class="analytics-grid">
            <div class="metric-card">
                <h3>Total Invoices</h3>
                <div class="value" id="total-invoices">0</div>
            </div>
            <div class="metric-card">
                <h3>Paid</h3>
                <div class="value" id="paid-invoices" style="color: var(--success);">0</div>
            </div>
            <div class="metric-card">
                <h3>Sent</h3>
                <div class="value" id="sent-invoices">0</div>
            </div>
            <div class="metric-card">
                <h3>Drafts</h3>
                <div class="value" id="draft-invoices" style="color: var(--error);">0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Recent Activity</h2>
        <div class="filter-bar">
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Invoice ID</label>
                    <input id="filter-id" placeholder="Filter by ID">
                </div>
                <div class="filter-group">
                    <label>Customer</label>
                    <input id="filter-customer" placeholder="Filter by customer">
                </div>
                <div class="filter-group">
                    <label>From Date</label>
                    <input id="filter-from" type="date">
                </div>
                <div class="filter-group">
                    <label>To Date</label>
                    <input id="filter-to" type="date">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filter-status">
                        <option value="">All</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <button id="clear-filters" style="background: #6b7280; color: white;">Clear Filters</button>
                <button id="export-csv-btn" class="cta">Export CSV</button>
            </div>
        </div>

        <div class="desktop-table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>Invoice ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Status</th>
                        <th>Actions</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="desktop-invoice-table"></tbody>
            </table>
        </div>

        <div id="mobile-invoice-list" class="mobile-invoice-list"></div>
        <div id="no-invoices" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
            <p>No invoices found. <button class="cta" id="create-first-invoice">Create your first invoice</button></p>
        </div>
    </div>

    <div class="card">
        <h2>Invoice Trends</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Invoices by Month</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Status Distribution</h3>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://qxpaplabjocxaftqocgu.supabase.co';
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4cGFwbGFiam9jeGFmdHFvY2d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTcyOTQsImV4cCI6MjA4MTIzMzI5NH0.VpoV9d2XGkRTv5UoZFKiA23IOOV2zasV18pW_9JmCj4";
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

let allInvoices = [];
let displayedInvoices = [];
let monthlyChart, statusChart;

// Theme toggle logic
function initTheme() {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isLight = saved === 'light' || (!saved && !prefersDark);

    if (isLight) {
        document.body.classList.add('light-mode');
    } else {
        document.body.classList.remove('light-mode');
    }

    document.getElementById('theme-toggle-desktop').checked = isLight;
    document.getElementById('theme-toggle-mobile').checked = isLight;
}

function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    document.getElementById('theme-toggle-desktop').checked = isLight;
    document.getElementById('theme-toggle-mobile').checked = isLight;
}

document.addEventListener('DOMContentLoaded', async () => {
    initTheme();

    document.getElementById('theme-toggle-desktop').addEventListener('change', toggleTheme);
    document.getElementById('theme-toggle-mobile').addEventListener('change', toggleTheme);

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = 'index.html';
        return;
    }

    const selectedSupplierId = localStorage.getItem('selected_supplier_id');
    const selectedSupplierName = localStorage.getItem('selected_supplier_name');
    if (selectedSupplierId && selectedSupplierName) {
        document.getElementById('active-supplier').textContent = `Active: ${selectedSupplierName}`;
    } else {
        document.getElementById('active-supplier').textContent = 'No supplier selected';
        // Optionally redirect or show message
    }

    // Mobile menu
    const hamburger = document.getElementById('hamburger');
    const mobileNav = document.getElementById('mobile-nav');
    const mobileNavClose = document.getElementById('mobile-nav-close');

    hamburger.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        mobileNav.classList.toggle('active');
    });

    mobileNavClose.addEventListener('click', () => {
        hamburger.classList.remove('active');
        mobileNav.classList.remove('active');
    });

    mobileNav.querySelectorAll('a, button').forEach(item => {
        item.addEventListener('click', () => {
            hamburger.classList.remove('active');
            mobileNav.classList.remove('active');
        });
    });

    const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
    mobileLogoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    });

    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    });

    const mobileCreateInvoiceBtn = document.getElementById('mobile-create-invoice-btn');
    mobileCreateInvoiceBtn.addEventListener('click', () => {
        window.location.href = 'form.html';
    });

    const createInvoiceBtn = document.getElementById('create-invoice-btn');
    createInvoiceBtn.addEventListener('click', () => {
        window.location.href = 'form.html';
    });

    const createFirstInvoiceBtn = document.getElementById('create-first-invoice');
    if (createFirstInvoiceBtn) {
        createFirstInvoiceBtn.addEventListener('click', () => {
            window.location.href = 'form.html';
        });
    }

    await loadInvoices();
    setupEventListeners();
});

async function loadInvoices() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data, error } = await supabase
        .from('invoices')
        .select(`
            id,
            invoice_id,
            issue_date,
            total_amount,
            currency,
            status,
            xml_data,
            form_data,
            customer_id,
            customers (name)
        `)
        .eq('user_id', user.id)
        .order('issue_date', { ascending: false });

    if (error) {
        console.error('Error loading invoices:', error);
        return;
    }

    allInvoices = data.map(inv => ({
        id: inv.id,
        invoice_id: inv.invoice_id,
        issue_date: inv.issue_date,
        total_amount: inv.total_amount,
        currency: inv.currency,
        status: inv.status || 'draft',
        xml_data: inv.xml_data,
        form_data: inv.form_data,
        customer_name: inv.customers?.name || 'Unknown'
    }));

    applyFilters();
}

function setupEventListeners() {
    ['filter-id', 'filter-customer', 'filter-from', 'filter-to', 'filter-status'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', applyFilters);
            el.addEventListener('change', applyFilters);
        }
    });

    document.getElementById('clear-filters').addEventListener('click', () => {
        ['filter-id', 'filter-customer', 'filter-from', 'filter-to'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('filter-status').value = '';
        applyFilters();
    });

    document.getElementById('export-csv-btn').addEventListener('click', exportDisplayedToCSV);
}

function applyFilters() {
    let filtered = allInvoices;

    const idFilter = document.getElementById('filter-id').value.trim().toLowerCase();
    if (idFilter) filtered = filtered.filter(inv => (inv.invoice_id || '').toLowerCase().includes(idFilter));

    const custFilter = document.getElementById('filter-customer').value.trim().toLowerCase();
    if (custFilter) filtered = filtered.filter(inv => (inv.customer_name || '').toLowerCase().includes(custFilter));

    const fromDate = document.getElementById('filter-from').value;
    if (fromDate) filtered = filtered.filter(inv => inv.issue_date >= fromDate);

    const toDate = document.getElementById('filter-to').value;
    if (toDate) filtered = filtered.filter(inv => inv.issue_date <= toDate);

    const statusFilter = document.getElementById('filter-status').value;
    if (statusFilter) filtered = filtered.filter(inv => inv.status === statusFilter);

    displayedInvoices = filtered;
    renderAnalytics(filtered);
    renderDesktopTable(filtered);
    renderMobileCards(filtered);

    const noInvoices = document.getElementById('no-invoices');
    if (filtered.length === 0) {
        noInvoices.style.display = 'block';
    } else {
        noInvoices.style.display = 'none';
    }
}

function renderAnalytics(invoices) {
    const total = invoices.length;
    const paid = invoices.filter(inv => inv.status === 'paid').length;
    const sent = invoices.filter(inv => inv.status === 'sent').length;
    const drafts = invoices.filter(inv => inv.status === 'draft').length;

    document.getElementById('total-invoices').textContent = total;
    document.getElementById('paid-invoices').textContent = paid;
    document.getElementById('sent-invoices').textContent = sent;
    document.getElementById('draft-invoices').textContent = drafts;

    updateCharts(invoices);
}

function renderDesktopTable(invoices) {
    const tbody = document.getElementById('desktop-invoice-table');
    tbody.innerHTML = '';

    invoices.forEach(inv => {
        let statusColor = inv.status === 'paid' ? '#10b981' : inv.status === 'sent' ? 'var(--success)' : 'var(--error)';
        let statusText = inv.status === 'paid' ? 'Paid' : inv.status === 'sent' ? 'Sent' : 'Draft';

        const statusBadge = `<span style="padding:6px 14px; border-radius:50px; font-size:12px; font-weight:600; background:${statusColor}; color:white;">${statusText}</span>`;

        const isDraft = inv.status === 'draft';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${inv.invoice_id || 'N/A'}</strong></td>
            <td>${inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('sv-SE') : '‚Äî'}</td>
            <td>${inv.customer_name || '‚Äî'}</td>
            <td><strong>${inv.total_amount ? parseFloat(inv.total_amount).toFixed(2) : '0.00'}</strong></td>
            <td>${inv.currency || 'EUR'}</td>
            <td>${statusBadge}</td>
            <td class="actions-cell">
                ${isDraft ? `<button class="action-btn edit-btn" data-id="${inv.id}">Edit Draft</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn view-btn" data-id="${inv.id}">View XML</button>` : '<span style="color:var(--text-secondary);font-size:11px;">XML not generated</span>'}
                ${inv.xml_data ? `<button class="action-btn download-btn" data-id="${inv.id}">Download</button>` : ''}
            </td>
            <td class="delete-cell">
                ${isDraft ? `<span class="delete-cross" data-id="${inv.id}" title="Delete Draft">√ó</span>` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });

    attachActionListeners();
}

function renderMobileCards(invoices) {
    const container = document.getElementById('mobile-invoice-list');
    const noMsg = document.getElementById('no-invoices');

    if (invoices.length === 0) {
        noMsg.style.display = 'block';
        container.innerHTML = '';
        return;
    }

    noMsg.style.display = 'none';
    container.innerHTML = '';

    invoices.forEach(inv => {
        let statusColor = inv.status === 'paid' ? '#10b981' : inv.status === 'sent' ? 'var(--success)' : 'var(--error)';
        let statusText = inv.status === 'paid' ? 'Paid' : inv.status === 'sent' ? 'Sent' : 'Draft';

        const statusBadge = `<span style="padding:8px 16px; border-radius:50px; font-size:14px; font-weight:600; background:${statusColor}; color:white;">${statusText}</span>`;

        const isDraft = inv.status === 'draft';

        const card = document.createElement('div');
        card.className = 'invoice-card';
        card.innerHTML = `
            <div class="invoice-card-header">
                <div>
                    <strong style="font-size:20px;">${inv.invoice_id || 'N/A'}</strong><br>
                    <span style="color:var(--text-secondary);">${inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('sv-SE') : '‚Äî'}</span>
                </div>
                ${statusBadge}
            </div>
            <div class="invoice-card-main">
                <div class="invoice-card-label">Customer</div>
                <div class="invoice-card-value">${inv.customer_name || '‚Äî'}</div>

                <div class="invoice-card-label">Total</div>
                <div class="invoice-card-value"><strong>${inv.total_amount ? parseFloat(inv.total_amount).toFixed(2) : '0.00'} ${inv.currency || 'EUR'}</strong></div>
            </div>
            <div class="invoice-card-actions">
                ${isDraft ? `<button class="action-btn edit-btn" data-id="${inv.id}">Edit Draft</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn view-btn" data-id="${inv.id}">View XML</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn download-btn" data-id="${inv.id}">Download</button>` : ''}
            </div>
            ${isDraft ? `<div class="delete-cell-mobile"><span class="delete-cross" data-id="${inv.id}">√ó</span></div>` : ''}
        `;
        container.appendChild(card);
    });

    attachActionListeners();
}

function attachActionListeners() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => {
            const invId = btn.dataset.id;
            const inv = allInvoices.find(i => i.id === invId);
            if (!inv) return alert('Invoice not found.');

            let formData = inv.form_data;
            if (typeof formData === 'string') {
                try { formData = JSON.parse(formData); } catch (e) { return alert('Corrupted form data.'); }
            }

            if (formData && typeof formData === 'object' && Object.keys(formData).length > 0) {
                localStorage.setItem('draft_form_data', JSON.stringify(formData));
                localStorage.setItem('editing_draft_id', inv.id);
                window.location.href = 'form.html?mode=edit_draft';
            } else {
                alert('No valid form data found for this draft.');
            }
        };
    });

    document.querySelectorAll('.delete-cross').forEach(icon => {
        icon.onclick = async () => {
            if (!confirm("Are you sure you want to delete this draft? This cannot be undone.")) return;

            const invId = icon.dataset.id;
            const { error } = await supabase.from('invoices').delete().eq('id', invId);

            if (error) {
                alert('Failed to delete draft: ' + error.message);
            } else {
                alert('Draft deleted successfully.');
                allInvoices = allInvoices.filter(i => i.id !== invId);
                applyFilters();
            }
        };
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.onclick = () => {
            const inv = allInvoices.find(i => i.id === btn.dataset.id);
            if (inv && inv.xml_data) {
                const blob = new Blob([inv.xml_data], { type: 'application/xml' });
                window.open(URL.createObjectURL(blob), '_blank');
            }
        };
    });

    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.onclick = () => {
            const inv = allInvoices.find(i => i.id === btn.dataset.id);
            if (inv && inv.xml_data) {
                const blob = new Blob([inv.xml_data], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${inv.invoice_id || 'invoice'}.xml`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
    });
}

function updateCharts(invoices) {
    const monthlyData = {};
    invoices.forEach(inv => {
        if (inv.issue_date) {
            const month = new Date(inv.issue_date).toLocaleDateString('en-CA', { year: 'numeric', month: 'short' });
            monthlyData[month] = (monthlyData[month] || 0) + 1;
        }
    });

    const monthlyLabels = Object.keys(monthlyData).sort();
    const monthlyValues = monthlyLabels.map(label => monthlyData[label]);

    if (monthlyChart) monthlyChart.destroy();
    const ctx1 = document.getElementById('monthlyChart').getContext('2d');
    monthlyChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: 'Invoices',
                data: monthlyValues,
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    const statusData = {
        draft: invoices.filter(inv => inv.status === 'draft').length,
        sent: invoices.filter(inv => inv.status === 'sent').length,
        paid: invoices.filter(inv => inv.status === 'paid').length
    };

    if (statusChart) statusChart.destroy();
    const ctx2 = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Draft', 'Sent', 'Paid'],
            datasets: [{
                data: [statusData.draft, statusData.sent, statusData.paid],
                backgroundColor: ['#ef4444', '#10b981', '#3b82f6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function exportDisplayedToCSV() {
    if (displayedInvoices.length === 0) {
        alert('No invoices currently displayed to export.');
        return;
    }

    let csv = 'Invoice ID,Issue Date,Customer Name,Total Amount,Currency,Status\n';

    displayedInvoices.forEach(inv => {
        const status = inv.status ? inv.status.charAt(0).toUpperCase() + inv.status.slice(1) : 'Draft';
        const customer = (inv.customer_name || '').replace(/"/g, '""');
        csv += `"${inv.invoice_id || ''}","${inv.issue_date || ''}","${customer}","${inv.total_amount || '0.00'}","${inv.currency || 'EUR'}","${status}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `invoices_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoker Dashboard</title>
<style type="text/css">@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --bg-dark: #070d18;
    --bg-darker: #050a14;
    --primary: #2563eb;
    --accent: #facc15;
    --white: #ffffff;
    --glass: rgba(255, 255, 255, 0.06);
    --border: rgba(255, 255, 255, 0.12);
    --text-secondary: rgba(255, 255, 255, 0.7);
    --success: #22c55e;
    --error: #dc2626;
}
/* Light Mode - Softer, easier on eyes */
body.light-mode {
    --bg-dark: #f1f5f9; /* Soft slate background */
    --bg-darker: #e2e8f0;
    --primary: #2563eb;
    --accent: #f59e0b; /* Warmer accent */
    --glass: rgba(255, 255, 255, 0.85);
    --border: rgba(0, 0, 0, 0.1);
    --text-secondary: rgba(0, 0, 0, 0.65);
    --success: #16a34a;
    --error: #dc2626;
    background: var(--bg-dark);
    color: #1e293b; /* Softer dark text */
}
body.light-mode .card {
    background: var(--glass);
    border-color: var(--border);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}
body.light-mode table th {
    background: rgba(0, 0, 0, 0.04);
}
body.light-mode input,
body.light-mode select,
body.light-mode textarea {
    background: rgba(255, 255, 255, 0.95);
    color: #1e293b;
    border-color: var(--border);
}
body.light-mode .action-btn,
body.light-mode .cta,
body.light-mode .logout-btn {
    color: white;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
    font-family:'Inter',sans-serif;
    background: var(--bg-dark);
    color: var(--white);
    padding-top: 80px;
    min-height: 100vh;
}
/* Header - Desktop */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 50px;
    background: rgba(5, 10, 20, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}
.header-left {
    display: flex;
    align-items: center;
    gap: 24px;
}
header h1 {
    font-size: 26px;
    font-weight: 700;
    margin: 0;
    color: var(--white);
}
#active-supplier {
    font-size: 16px;
    color: var(--accent);
    font-weight: 500;
    background: rgba(250, 204, 21, 0.15);
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid rgba(250, 204, 21, 0.3);
}
.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}
.logout-group {
    display: flex;
    align-items: center;
    gap: 16px;
}
/* Language Selector - Desktop */
.language-selector {
    position: relative;
}
.language-globe {
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 12px;
    transition: background 0.3s ease;
}
.language-globe:hover {
    background: rgba(255, 255, 255, 0.1);
}
.language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 12px;
    min-width: 180px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    margin-top: 8px;
}
.language-selector:hover .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.language-dropdown button {
    display: block;
    width: 100%;
    padding: 12px 16px;
    background: none;
    border: none;
    text-align: left;
    color: var(--white);
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s ease;
}
.language-dropdown button:hover {
    background: rgba(255, 255, 255, 0.1);
}
body.light-mode .language-dropdown {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 0, 0, 0.1);
}
body.light-mode .language-dropdown button {
    color: #1e293b;
}
body.light-mode .language-dropdown button:hover {
    background: rgba(0, 0, 0, 0.08);
}
/* Hamburger - Mobile Only */
.hamburger {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 30px;
    height: 21px;
    cursor: pointer;
    z-index: 101;
}
.hamburger span {
    display: block;
    height: 3px;
    width: 100%;
    background: var(--white);
    border-radius: 3px;
    transition: all 0.3s ease;
}
.hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
.hamburger.active span:nth-child(2) { opacity: 0; }
.hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
/* Mobile Nav Overlay */
.mobile-nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg-dark);
    color: var(--white);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 32px;
    transform: translateX(100%);
    transition: transform 0.4s ease;
    z-index: 100;
    visibility: hidden;
    pointer-events: none;
}
body.light-mode .mobile-nav {
    background: var(--bg-dark);
    color: #1e293b;
}
.mobile-nav.active {
    transform: translateX(0);
    visibility: visible;
    pointer-events: auto;
}
.mobile-nav button {
    font-size: 24px;
    font-weight: 600;
    color: inherit;
    background: none;
    border: none;
    padding: 12px 24px;
    width: 80%;
    text-align: center;
    border-radius: 12px;
    cursor: pointer;
}
.mobile-nav button:hover {
    background: rgba(255, 255, 255, 0.1);
}
body.light-mode .mobile-nav button:hover {
    background: rgba(0, 0, 0, 0.08);
}
.mobile-nav-close {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 32px;
    color: inherit;
    background: none;
    border: none;
    cursor: pointer;
}
.cta, .logout-btn {
    padding: 10px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}
.cta {
    background: var(--primary);
    color: white;
}
.cta:hover {
    background: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}
.logout-btn {
    background: var(--accent);
    color: #000;
}
.logout-btn:hover {
    background: #fde047;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(250, 204, 21, 0.4);
}
/* Theme Toggle Switch */
.theme-toggle {
    position: relative;
    display: inline-block;
    width: 56px;
    height: 30px;
}
.theme-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #64748b;
    transition: .4s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #facc15;
}
input:checked + .slider:before {
    transform: translateX(26px);
}
.slider:after {
    content: 'üåô';
    color: white;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    transition: .4s;
}
input:checked + .slider:after {
    content: '‚òÄÔ∏è';
    left: 8px;
    right: auto;
}
.main { max-width: 1200px; margin: 50px auto; padding: 20px; display: flex; flex-direction: column; gap: 40px; }
.card { background: var(--glass); padding: 30px; border-radius: 20px; border: 1px solid var(--border); backdrop-filter: blur(12px); }
.card h2 { margin-bottom: 20px; color: var(--accent); }
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 24px;
}
.metric-card {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    border: 1px solid var(--border);
}
.metric-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}
.metric-card .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
}
.charts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    margin-top: 40px;
}
.chart-container {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid var(--border);
    height: 340px;
    position: relative;
}
.chart-container h3 {
    text-align: center;
    margin-bottom: 16px;
    color: var(--white);
    font-size: 18px;
}
.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}
.filter-bar {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}
.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}
.filter-group {
    display: flex;
    flex-direction: column;
}
.filter-group label {
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--text-secondary);
}
.filter-group input,
.filter-group select {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.08);
    color: white;
    font-size: 16px;
}

/* Fix for select dropdowns in light mode - ensure readable text */
body.light-mode .filter-group select {
    background: #ffffff;
    color: #1e293b;
}

/* Ensure options inside select are readable in both modes */
select option {
    background: var(--bg-dark);
    color: var(--white);
}
body.light-mode select option {
    background: #ffffff;
    color: #1e293b;
}

#clear-filters,
#export-csv-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    align-self: flex-start;
}
#clear-filters {
    background: #6b7280;
}
#export-csv-btn {
    background: var(--success);
    color: white;
}
.desktop-table-wrapper {
    overflow-x: auto;
    border-radius: 16px;
    border: 1px solid var(--border);
    margin-top: 16px;
    -webkit-overflow-scrolling: touch;
}
.table {
    width: 100%;
    min-width: 1000px;
    border-collapse: collapse;
}
.table th,
.table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}
.table th {
    background: rgba(255,255,255,0.05);
    position: sticky;
    top: 0;
    z-index: 10;
}
.action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}
.view-btn { background: var(--primary); color: white; }
.download-btn { background: var(--accent); color: black; }
.edit-btn { background: #f59e0b; color: white; }
.table th:last-child {
    width: 70px;
    min-width: 70px;
    text-align: center;
}
.table td:last-child {
    text-align: center;
    padding: 16px 8px;
}
.delete-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-size: 20px;
    color: var(--error);
    background: rgba(220, 38, 38, 0.15);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.delete-icon:hover {
    background: rgba(220, 38, 38, 0.3);
    transform: scale(1.1);
}
.mobile-invoice-list {
    display: none;
    flex-direction: column;
    gap: 16px;
    margin-top: 16px;
}
.invoice-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
}
.invoice-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
}
.invoice-card-main {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 16px;
    margin-bottom: 16px;
    font-size: 15px;
}
.invoice-card-label {
    color: var(--text-secondary);
    font-weight: 500;
}
.invoice-card-value strong {
    font-size: 18px;
    color: var(--accent);
}
.invoice-card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}
.invoice-card-actions .action-btn {
    flex: 1;
    min-width: 90px;
    text-align: center;
    padding: 8px 12px;
    font-size: 13px;
}
.delete-cell-mobile {
    text-align: right;
}
@media (max-width: 768px) {
    .delete-icon::before {
        content: none;
    }
    .delete-icon {
        background: none;
        width: auto;
        height: auto;
        font-size: 15px;
        color: var(--error);
    }
    .delete-icon:hover {
        background: none;
        transform: none;
        text-decoration: underline;
    }
}
.no-invoices {
    color: var(--text-secondary);
    font-style: italic;
    padding: 40px 0;
    font-size: 18px;
    text-align: center;
}
@media (max-width: 768px) {
    header {
        padding: 0 20px;
        height: 70px;
    }
    .header-left h1 {
        font-size: 22px;
    }
    .header-right {
        display: none;
    }
    .hamburger {
        display: flex;
    }
    .main {
        margin: 30px auto;
        padding: 16px;
    }
    .card {
        padding: 24px;
    }
    .card h2 {
        font-size: 24px;
    }
    .filter-controls {
        grid-template-columns: 1fr;
    }
    .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .metric-card .value {
        font-size: 24px;
    }
    .desktop-table-wrapper {
        display: none;
    }
    .mobile-invoice-list {
        display: flex;
    }
}

/* Sortable table headers */
.table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 32px !important;
}
.table th.sortable::after {
    content: '‚Üï';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.4;
    font-size: 14px;
}
.table th.sortable.asc::after {
    content: '‚Üë';
    opacity: 1;
}
.table th.sortable.desc::after {
    content: '‚Üì';
    opacity: 1;
}
</style>
</head>
<body>
<header>
    <div class="header-left">
        <h1 data-i18n="dashboard">Dashboard</h1>
        <span id="active-supplier"></span>
    </div>

    <div class="header-right">
        <button id="create-invoice-btn" class="cta" data-i18n="create_invoice">Create Invoice</button>
        <button id="suppliers-btn" class="cta" data-i18n="switch_supplier">Switch Supplier</button>
        <button id="customers-btn" class="cta" data-i18n="customers">Customers</button>

        <div class="logout-group">
            <!-- Language Selector -->
            <div class="language-selector">
                <div class="language-globe" title="Change language">üåê</div>
                <div class="language-dropdown">
                    <button data-lang="en">English</button>
                    <button data-lang="sv">Svenska</button>
                    <button data-lang="no">Norsk</button>
                    <button data-lang="da">Dansk</button>
                    <button data-lang="fr">Fran√ßais</button>
                    <button data-lang="es">Espa√±ol</button>
                    <button data-lang="de">Deutsch</button>
                    <button data-lang="it">Italiano</button>
                    <button data-lang="nl">Nederlands</button>
                    <button data-lang="pl">Polski</button>
                </div>
            </div>

            <button id="logout-btn" class="logout-btn" data-i18n="logout">Logout</button>
            <label class="theme-toggle">
                <input type="checkbox" id="theme-switch">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
</header>

<div class="mobile-nav" id="mobile-nav">
    <button class="mobile-nav-close" id="mobile-nav-close">√ó</button>
    <button id="mobile-create-invoice-btn" data-i18n="create_invoice">Create Invoice</button>
    <button id="mobile-suppliers-btn" data-i18n="switch_supplier">Switch Supplier</button>
    <button id="mobile-customers-btn" data-i18n="customers">Customers</button>

    <!-- Mobile language selector -->
    <div class="language-selector" style="margin: 20px 0;">
        <div class="language-globe" style="font-size: 32px;">üåê</div>
        <div class="language-dropdown">
            <button data-lang="en">English</button>
            <button data-lang="sv">Svenska</button>
            <button data-lang="no">Norsk</button>
            <button data-lang="da">Dansk</button>
            <button data-lang="fr">Fran√ßais</button>
            <button data-lang="es">Espa√±ol</button>
            <button data-lang="de">Deutsch</button>
            <button data-lang="it">Italiano</button>
            <button data-lang="nl">Nederlands</button>
            <button data-lang="pl">Polski</button>
        </div>
    </div>

    <label class="theme-toggle" style="margin:20px 0;">
        <input type="checkbox" id="mobile-theme-switch">
        <span class="slider"></span>
    </label>
    <button id="mobile-logout-btn" class="logout-btn" data-i18n="logout">Logout</button>
</div>

<div class="main">
    <div class="card">
        <h2 data-i18n="analytics_overview">Analytics Overview</h2>
        <div class="analytics-grid" id="metrics-grid"></div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3 data-i18n="monthly_revenue">Monthly Revenue (Billed vs Paid)</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 data-i18n="invoice_status_distribution">Invoice Status Distribution</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 data-i18n="top_customers">Top 5 Customers by Revenue</h3>
                <canvas id="topCustomersChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 data-i18n="receivables_aging">Receivables Aging</h3>
                <canvas id="agingChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 data-i18n="invoice_history">Invoice History</h2>
        <div class="filter-bar">
            <div class="filter-controls">
                <div class="filter-group">
                    <label data-i18n="search_invoice_id">Search Invoice ID</label>
                    <input type="text" id="filter-id" placeholder="e.g. INV-001">
                </div>
                <div class="filter-group">
                    <label data-i18n="customer">Customer</label>
                    <input type="text" id="filter-customer" placeholder="Customer name">
                </div>
                <div class="filter-group">
                    <label data-i18n="from_date">From Date</label>
                    <input type="date" id="filter-from">
                </div>
                <div class="filter-group">
                    <label data-i18n="to_date">To Date</label>
                    <input type="date" id="filter-to">
                </div>
                <div class="filter-group">
                    <label data-i18n="status">Status</label>
                    <select id="filter-status">
                        <option value="">All</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <button id="clear-filters" data-i18n="clear_filters">Clear Filters</button>
            </div>
            <button id="export-csv-btn" data-i18n="export_csv">Export Displayed to CSV</button>
        </div>

        <div class="desktop-table-wrapper">
            <table id="invoices-table" class="table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="invoice_id" data-i18n="invoice_id">Invoice ID</th>
                        <th class="sortable" data-sort="issue_date" data-i18n="date">Date</th>
                        <th data-i18n="customer">Customer</th>
                        <th class="sortable" data-sort="total_amount" data-i18n="total">Total</th>
                        <th data-i18n="currency">Currency</th>
                        <th class="sortable" data-sort="status" data-i18n="status">Status</th>
                        <th data-i18n="actions">Actions</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="8" class="no-invoices">Loading invoices...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mobile-invoice-list" id="mobile-invoice-list"></div>

        <div id="empty-state" class="empty-state" style="display:none;">
            <h3 data-i18n="no_invoices_yet">No invoices yet</h3>
            <p data-i18n="get_started_peppol">Get started by creating your first PEPPOL invoice.</p>
            <button id="empty-create-btn" class="cta" data-i18n="create_invoice">Create Invoice</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// i18n translation dictionary
const translations = {
    en: {
        dashboard: "Dashboard",
        create_invoice: "Create Invoice",
        switch_supplier: "Switch Supplier",
        customers: "Customers",
        logout: "Logout",
        analytics_overview: "Analytics Overview",
        monthly_revenue: "Monthly Revenue (Billed vs Paid)",
        invoice_status_distribution: "Invoice Status Distribution",
        top_customers: "Top 5 Customers by Revenue",
        receivables_aging: "Receivables Aging",
        invoice_history: "Invoice History",
        search_invoice_id: "Search Invoice ID",
        customer: "Customer",
        from_date: "From Date",
        to_date: "To Date",
        status: "Status",
        clear_filters: "Clear Filters",
        export_csv: "Export Displayed to CSV",
        invoice_id: "Invoice ID",
        date: "Date",
        total: "Total",
        currency: "Currency",
        actions: "Actions",
        no_invoices_yet: "No invoices yet",
        get_started_peppol: "Get started by creating your first PEPPOL invoice."
    },
    sv: {
        dashboard: "Instrumentpanel",
        create_invoice: "Skapa faktura",
        switch_supplier: "Byt leverant√∂r",
        customers: "Kunder",
        logout: "Logga ut",
        analytics_overview: "Analys√∂versikt",
        monthly_revenue: "M√•natliga int√§kter (Fakturerat vs Betalt)",
        invoice_status_distribution: "Fakturastatusf√∂rdelning",
        top_customers: "Topp 5 kunder efter int√§kt",
        receivables_aging: "Fordringar per √•lder",
        invoice_history: "Fakturahistorik",
        search_invoice_id: "S√∂k faktura-ID",
        customer: "Kund",
        from_date: "Fr√•n datum",
        to_date: "Till datum",
        status: "Status",
        clear_filters: "Rensa filter",
        export_csv: "Exportera visade till CSV",
        invoice_id: "Faktura-ID",
        date: "Datum",
        total: "Totalt",
        currency: "Valuta",
        actions: "√Ötg√§rder",
        no_invoices_yet: "Inga fakturor √§nnu",
        get_started_peppol: "Kom ig√•ng genom att skapa din f√∂rsta PEPPOL-faktura."
    },
    no: {
        dashboard: "Dashbord",
        create_invoice: "Opprett faktura",
        switch_supplier: "Bytt leverand√∏r",
        customers: "Kunder",
        logout: "Logg ut",
        analytics_overview: "Analyseoversikt",
        monthly_revenue: "M√•nedlige inntekter (Fakturert vs Betalt)",
        invoice_status_distribution: "Fakturastatusfordeling",
        top_customers: "Topp 5 kunder etter inntekt",
        receivables_aging: "Kundefordringer etter alder",
        invoice_history: "Fakturahistorikk",
        search_invoice_id: "S√∏k faktura-ID",
        customer: "Kunde",
        from_date: "Fra dato",
        to_date: "Til dato",
        status: "Status",
        clear_filters: "Fjern filtre",
        export_csv: "Eksporter viste til CSV",
        invoice_id: "Faktura-ID",
        date: "Dato",
        total: "Totalt",
        currency: "Valuta",
        actions: "Handlinger",
        no_invoices_yet: "Ingen fakturaer enn√•",
        get_started_peppol: "Kom i gang ved √• opprette din f√∏rste PEPPOL-faktura."
    },
    da: {
        dashboard: "Dashboard",
        create_invoice: "Opret faktura",
        switch_supplier: "Skift leverand√∏r",
        customers: "Kunder",
        logout: "Log ud",
        analytics_overview: "Analyseoversigt",
        monthly_revenue: "M√•nedlige indt√¶gter (Faktureret vs Betalt)",
        invoice_status_distribution: "Fakturastatusfordeling",
        top_customers: "Top 5 kunder efter indt√¶gt",
        receivables_aging: "Tilgodehavender efter alder",
        invoice_history: "Fakturahistorik",
        search_invoice_id: "S√∏g faktura-ID",
        customer: "Kunde",
        from_date: "Fra dato",
        to_date: "Til dato",
        status: "Status",
        clear_filters: "Ryd filtre",
        export_csv: "Eksporter viste til CSV",
        invoice_id: "Faktura-ID",
        date: "Dato",
        total: "Total",
        currency: "Valuta",
        actions: "Handlinger",
        no_invoices_yet: "Ingen fakturaer endnu",
        get_started_peppol: "Kom i gang ved at oprette din f√∏rste PEPPOL-faktura."
    },
    fr: {
        dashboard: "Tableau de bord",
        create_invoice: "Cr√©er une facture",
        switch_supplier: "Changer de fournisseur",
        customers: "Clients",
        logout: "Se d√©connecter",
        analytics_overview: "Aper√ßu analytique",
        monthly_revenue: "Revenus mensuels (Factur√© vs Pay√©)",
        invoice_status_distribution: "R√©partition du statut des factures",
        top_customers: "Top 5 clients par revenu",
        receivables_aging: "√âch√©ancier des cr√©ances",
        invoice_history: "Historique des factures",
        search_invoice_id: "Rechercher ID facture",
        customer: "Client",
        from_date: "Date de d√©but",
        to_date: "Date de fin",
        status: "Statut",
        clear_filters: "Effacer les filtres",
        export_csv: "Exporter l'affichage vers CSV",
        invoice_id: "ID facture",
        date: "Date",
        total: "Total",
        currency: "Devise",
        actions: "Actions",
        no_invoices_yet: "Aucune facture pour le moment",
        get_started_peppol: "Commencez par cr√©er votre premi√®re facture PEPPOL."
    },
    es: {
        dashboard: "Panel de control",
        create_invoice: "Crear factura",
        switch_supplier: "Cambiar proveedor",
        customers: "Clientes",
        logout: "Cerrar sesi√≥n",
        analytics_overview: "Resumen anal√≠tico",
        monthly_revenue: "Ingresos mensuales (Facturado vs Pagado)",
        invoice_status_distribution: "Distribuci√≥n del estado de facturas",
        top_customers: "Top 5 clientes por ingresos",
        receivables_aging: "Antig√ºedad de cuentas por cobrar",
        invoice_history: "Historial de facturas",
        search_invoice_id: "Buscar ID de factura",
        customer: "Cliente",
        from_date: "Desde fecha",
        to_date: "Hasta fecha",
        status: "Estado",
        clear_filters: "Borrar filtros",
        export_csv: "Exportar mostrados a CSV",
        invoice_id: "ID factura",
        date: "Fecha",
        total: "Total",
        currency: "Moneda",
        actions: "Acciones",
        no_invoices_yet: "A√∫n no hay facturas",
        get_started_peppol: "Comience creando su primera factura PEPPOL."
    },
    de: {
        dashboard: "Dashboard",
        create_invoice: "Rechnung erstellen",
        switch_supplier: "Lieferant wechseln",
        customers: "Kunden",
        logout: "Abmelden",
        analytics_overview: "Analyse√ºbersicht",
        monthly_revenue: "Monatliche Einnahmen (Abgerechnet vs Bezahlt)",
        invoice_status_distribution: "Rechnungsstatusverteilung",
        top_customers: "Top 5 Kunden nach Umsatz",
        receivables_aging: "Forderungsalterung",
        invoice_history: "Rechnungshistorie",
        search_invoice_id: "Rechnungs-ID suchen",
        customer: "Kunde",
        from_date: "Von Datum",
        to_date: "Bis Datum",
        status: "Status",
        clear_filters: "Filter zur√ºcksetzen",
        export_csv: "Angezeigte als CSV exportieren",
        invoice_id: "Rechnungs-ID",
        date: "Datum",
        total: "Gesamt",
        currency: "W√§hrung",
        actions: "Aktionen",
        no_invoices_yet: "Noch keine Rechnungen",
        get_started_peppol: "Beginnen Sie mit der Erstellung Ihrer ersten PEPPOL-Rechnung."
    },
    it: {
        dashboard: "Dashboard",
        create_invoice: "Crea fattura",
        switch_supplier: "Cambia fornitore",
        customers: "Clienti",
        logout: "Esci",
        analytics_overview: "Panoramica analitica",
        monthly_revenue: "Entrate mensili (Fatturato vs Pagato)",
        invoice_status_distribution: "Distribuzione stato fatture",
        top_customers: "Top 5 clienti per fatturato",
        receivables_aging: "Invecchiamento crediti",
        invoice_history: "Cronologia fatture",
        search_invoice_id: "Cerca ID fattura",
        customer: "Cliente",
        from_date: "Dalla data",
        to_date: "Alla data",
        status: "Stato",
        clear_filters: "Cancella filtri",
        export_csv: "Esporta visualizzati in CSV",
        invoice_id: "ID fattura",
        date: "Data",
        total: "Totale",
        currency: "Valuta",
        actions: "Azioni",
        no_invoices_yet: "Nessuna fattura ancora",
        get_started_peppol: "Inizia creando la tua prima fattura PEPPOL."
    },
    nl: {
        dashboard: "Dashboard",
        create_invoice: "Factuur aanmaken",
        switch_supplier: "Leverancier wisselen",
        customers: "Klanten",
        logout: "Uitloggen",
        analytics_overview: "Analyseoverzicht",
        monthly_revenue: "Maandelijkse omzet (Gefactureerd vs Betaald)",
        invoice_status_distribution: "Factuurstatusverdeling",
        top_customers: "Top 5 klanten op omzet",
        receivables_aging: "Debiteurenveroudering",
        invoice_history: "Factuurhistorie",
        search_invoice_id: "Zoek factuur-ID",
        customer: "Klant",
        from_date: "Van datum",
        to_date: "Tot datum",
        status: "Status",
        clear_filters: "Filters wissen",
        export_csv: "Getoonde exporteren naar CSV",
        invoice_id: "Factuur-ID",
        date: "Datum",
        total: "Totaal",
        currency: "Valuta",
        actions: "Acties",
        no_invoices_yet: "Nog geen facturen",
        get_started_peppol: "Begin met het aanmaken van je eerste PEPPOL-factuur."
    },
    pl: {
        dashboard: "Panel",
        create_invoice: "Utw√≥rz fakturƒô",
        switch_supplier: "Zmie≈Ñ dostawcƒô",
        customers: "Klienci",
        logout: "Wyloguj",
        analytics_overview: "PrzeglƒÖd analiz",
        monthly_revenue: "Przychody miesiƒôczne (Zafakturowane vs Zap≈Çacone)",
        invoice_status_distribution: "Rozk≈Çad statusu faktur",
        top_customers: "Top 5 klient√≥w wg przychodu",
        receivables_aging: "Starzenie nale≈ºno≈õci",
        invoice_history: "Historia faktur",
        search_invoice_id: "Szukaj ID faktury",
        customer: "Klient",
        from_date: "Od daty",
        to_date: "Do daty",
        status: "Status",
        clear_filters: "Wyczy≈õƒá filtry",
        export_csv: "Eksportuj wy≈õwietlone do CSV",
        invoice_id: "ID faktury",
        date: "Data",
        total: "Suma",
        currency: "Waluta",
        actions: "Akcje",
        no_invoices_yet: "Brak faktur",
        get_started_peppol: "Zacznij od utworzenia pierwszej faktury PEPPOL."
    }
};

// Current language (default: English)
let currentLang = localStorage.getItem('preferred_language') || 'en';

// Function to apply translations
function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.dataset.i18n;
        if (translations[currentLang] && translations[currentLang][key]) {
            element.textContent = translations[currentLang][key];
        }
    });
}

// Language change handler
document.querySelectorAll('.language-dropdown button').forEach(btn => {
    btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        localStorage.setItem('preferred_language', currentLang);
        applyTranslations();
        // Optional: reload charts to update any dynamic text if needed
        renderAnalytics(displayedInvoices);
    });
});

const supabaseUrl = 'https://qxpaplabjocxaftqocgu.supabase.co';
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4cGFwbGFiam9jeGFmdHFvY2d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTcyOTQsImV4cCI6MjA4MTIzMzI5NH0.VpoV9d2XGkRTv5UoZFKiA23IOOV2zasV18pW_9JmCj4";
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

let allInvoices = [];
let displayedInvoices = [];
let currentSort = { key: 'issue_date', direction: 'desc' };
let revenueChart = null;
let statusChart = null;
let topCustomersChart = null;
let agingChart = null;

const hamburger = document.getElementById('hamburger');
const mobileNav = document.getElementById('mobile-nav');
const mobileNavClose = document.getElementById('mobile-nav-close');

hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    mobileNav.classList.toggle('active');
});

mobileNavClose.addEventListener('click', () => {
    hamburger.classList.remove('active');
    mobileNav.classList.remove('active');
});

mobileNav.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
        hamburger.classList.remove('active');
        mobileNav.classList.remove('active');
    });
});

document.addEventListener("DOMContentLoaded", async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = 'index.html';
        return;
    }

    const activeSupplierName = localStorage.getItem('selected_supplier_name');
    const activeSupplierSpan = document.getElementById('active-supplier');
    if (activeSupplierName) {
        activeSupplierSpan.textContent = `Active: ${activeSupplierName}`;
    } else {
        activeSupplierSpan.innerHTML = 'No supplier selected ‚Äî <a href="suppliers.html" style="color: var(--accent); text-decoration: underline;">Select one</a>';
    }

    const selectedSupplierId = localStorage.getItem('selected_supplier_id');
    if (!selectedSupplierId) {
        alert("Please select a supplier first.");
        window.location.href = 'suppliers.html';
        return;
    }

    document.getElementById('create-invoice-btn').addEventListener('click', () => window.location.href = 'form.html');
    document.getElementById('mobile-create-invoice-btn')?.addEventListener('click', () => window.location.href = 'form.html');
    document.getElementById('empty-create-btn')?.addEventListener('click', () => window.location.href = 'form.html');

    document.getElementById('suppliers-btn').addEventListener('click', () => window.location.href = 'suppliers.html');
    document.getElementById('mobile-suppliers-btn')?.addEventListener('click', () => window.location.href = 'suppliers.html');

    document.getElementById('customers-btn').addEventListener('click', () => window.location.href = 'customers.html');
    document.getElementById('mobile-customers-btn')?.addEventListener('click', () => window.location.href = 'customers.html');

    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('mobile-logout-btn')?.addEventListener('click', logout);

    async function logout() {
        await supabase.auth.signOut();
        localStorage.removeItem('selected_supplier_id');
        localStorage.removeItem('selected_supplier_name');
        window.location.href = 'index.html';
    }

    document.getElementById('export-csv-btn').addEventListener('click', exportDisplayedToCSV);

    const themeSwitch = document.getElementById('theme-switch');
    const mobileThemeSwitch = document.getElementById('mobile-theme-switch');
    const savedTheme = localStorage.getItem('theme');

    const applyTheme = (isLight) => {
        if (isLight) {
            document.body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
        } else {
            document.body.classList.remove('light-mode');
            localStorage.setItem('theme', 'dark');
        }
    };

    const preferredLight = !savedTheme && window.matchMedia('(prefers-color-scheme: light)').matches;
    const initialLight = savedTheme === 'light' || preferredLight;

    applyTheme(initialLight);
    themeSwitch.checked = initialLight;
    if (mobileThemeSwitch) mobileThemeSwitch.checked = initialLight;

    themeSwitch.addEventListener('change', () => {
        applyTheme(themeSwitch.checked);
        if (mobileThemeSwitch) mobileThemeSwitch.checked = themeSwitch.checked;
    });

    if (mobileThemeSwitch) {
        mobileThemeSwitch.addEventListener('change', () => {
            applyTheme(mobileThemeSwitch.checked);
            themeSwitch.checked = mobileThemeSwitch.checked;
        });
    }

    // Table sorting
    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.sort;
            if (currentSort.key === key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.direction = 'asc';
            }
            document.querySelectorAll('th.sortable').forEach(h => h.classList.remove('asc', 'desc'));
            th.classList.add(currentSort.direction);
            sortAndRender();
        });
    });

    // Apply saved language on load
    applyTranslations();

    await loadInvoices(session.user.id, selectedSupplierId);
});

function formatAmount(amount) {
    amount = parseFloat(amount) || 0;
    if (amount >= 1_000_000_000) {
        return (amount / 1_000_000_000).toFixed(1).replace('.0', '') + 'b';
    } else if (amount >= 1_000_000) {
        return (amount / 1_000_000).toFixed(1).replace('.0', '') + 'm';
    } else if (amount >= 1_000) {
        return (amount / 1_000).toFixed(1).replace('.0', '') + 'k';
    } else {
        return amount.toFixed(2);
    }
}

function sortInvoices(invoices) {
    const { key, direction } = currentSort;
    return [...invoices].sort((a, b) => {
        let valA = a[key] ?? '';
        let valB = b[key] ?? '';
        if (key === 'total_amount') {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
        } else if (key === 'issue_date') {
            valA = valA ? new Date(valA) : new Date(0);
            valB = valB ? new Date(valB) : new Date(0);
        } else if (key === 'status') {
            const order = { paid: 3, sent: 2, draft: 1, null: 1, '': 1 };
            valA = order[valA] || 0;
            valB = order[valB] || 0;
        }
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
}

function sortAndRender() {
    displayedInvoices = sortInvoices(displayedInvoices);
    renderDesktopTable(displayedInvoices);
    renderMobileCards(displayedInvoices);
}

async function loadInvoices(userId, supplierId) {
    const { data: invoices, error } = await supabase
        .from('invoices')
        .select('id, invoice_id, issue_date, customer_name, total_amount, currency, xml_data, status, form_data')
        .eq('user_id', userId)
        .eq('supplier_id', supplierId)
        .order('issue_date', { ascending: false });
    if (error) {
        const msg = `Error loading invoices: ${error.message}`;
        document.querySelector('#invoices-table tbody').innerHTML = `<tr><td colspan="8" class="no-invoices">${msg}</td></tr>`;
        document.getElementById('mobile-invoice-list').innerHTML = `<div class="no-invoices">${msg}</div>`;
        return;
    }
    allInvoices = invoices || [];
    applyFilters();
}

function renderAnalytics(invoices) {
    const totalInvoices = invoices.length;
    const totalRevenue = invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    const paidRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    const outstanding = totalRevenue - paidRevenue;
    const avgInvoice = totalInvoices > 0 ? totalRevenue / totalInvoices : 0;
    const drafts = invoices.filter(inv => !inv.status || inv.status === 'draft').length;
    const sent = invoices.filter(inv => inv.status === 'sent').length;
    const paid = invoices.filter(inv => inv.status === 'paid').length;
    document.getElementById('metrics-grid').innerHTML = `
        <div class="metric-card">
            <h3>Total Invoices</h3>
            <div class="value">${totalInvoices}</div>
        </div>
        <div class="metric-card">
            <h3>Total Billed</h3>
            <div class="value">${formatAmount(totalRevenue)}</div>
        </div>
        <div class="metric-card">
            <h3>Outstanding</h3>
            <div class="value">${formatAmount(outstanding)}</div>
        </div>
        <div class="metric-card">
            <h3>Avg. Invoice</h3>
            <div class="value">${formatAmount(avgInvoice)}</div>
        </div>
        <div class="metric-card">
            <h3>Drafts</h3>
            <div class="value">${drafts}</div>
        </div>
        <div class="metric-card">
            <h3>Sent</h3>
            <div class="value">${sent}</div>
        </div>
        <div class="metric-card">
            <h3>Paid</h3>
            <div class="value">${paid}</div>
        </div>
    `;
    const monthlyBilled = {};
    const monthlyPaid = {};
    invoices.forEach(inv => {
        if (inv.issue_date) {
            const month = inv.issue_date.substring(0, 7);
            const amount = parseFloat(inv.total_amount) || 0;
            monthlyBilled[month] = (monthlyBilled[month] || 0) + amount;
            if (inv.status === 'paid') monthlyPaid[month] = (monthlyPaid[month] || 0) + amount;
        }
    });
    const months = [...new Set([...Object.keys(monthlyBilled), ...Object.keys(monthlyPaid)])].sort();
    const billedData = months.map(m => monthlyBilled[m] || 0);
    const paidData = months.map(m => monthlyPaid[m] || 0);
    if (revenueChart) revenueChart.destroy();
    revenueChart = new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                { label: translations[currentLang]['billed'] || 'Billed', data: billedData, borderColor: '#facc15', backgroundColor: 'rgba(250,204,21,0.2)', tension: 0.3, fill: true },
                { label: translations[currentLang]['paid'] || 'Paid', data: paidData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.2)', tension: 0.3, fill: true }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 14, weight: '600' },
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                }
            }
        }
    });
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: [
                `${translations[currentLang]['draft'] || 'Draft'} (${formatAmount(outstanding)})`,
                `${translations[currentLang]['sent'] || 'Sent'} (${formatAmount(invoices.filter(i=>i.status==='sent').reduce((s,i)=>s+(parseFloat(i.total_amount)||0),0))})`,
                `${translations[currentLang]['paid'] || 'Paid'} (${formatAmount(paidRevenue)})`
            ],
            datasets: [{
                data: [drafts, sent, paid],
                backgroundColor: ['#ef4444', '#f59e0b', '#22c55e']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 13, weight: '600' },
                        padding: 12,
                        usePointStyle: true,
                        pointStyle: 'rectRounded',
                        boxWidth: 12,
                        boxHeight: 12
                    }
                }
            },
            layout: {
                padding: {
                    top: 20,
                    bottom: 20,
                    left: 20,
                    right: 20
                }
            }
        }
    });
    const customerRevenue = {};
    invoices.forEach(inv => {
        const name = inv.customer_name || 'Unknown';
        customerRevenue[name] = (customerRevenue[name] || 0) + (parseFloat(inv.total_amount) || 0);
    });
    const top5 = Object.entries(customerRevenue)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    if (topCustomersChart) topCustomersChart.destroy();
    topCustomersChart = new Chart(document.getElementById('topCustomersChart'), {
        type: 'bar',
        data: {
            labels: top5.map(c => c[0]),
            datasets: [{
                label: 'Revenue',
                data: top5.map(c => c[1]),
                backgroundColor: '#2563eb'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: { x: { beginAtZero: true } }
        }
    });
    const aging = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0 };
    const today = new Date();
    invoices.filter(inv => inv.status !== 'paid').forEach(inv => {
        if (!inv.issue_date) return;
        const days = Math.floor((today - new Date(inv.issue_date)) / (1000 * 60 * 60 * 24));
        const amount = parseFloat(inv.total_amount) || 0;
        if (days <= 30) aging['0-30'] += amount;
        else if (days <= 60) aging['31-60'] += amount;
        else if (days <= 90) aging['61-90'] += amount;
        else aging['90+'] += amount;
    });
    if (agingChart) agingChart.destroy();
    agingChart = new Chart(document.getElementById('agingChart'), {
        type: 'bar',
        data: {
            labels: ['0-30 days', '31-60 days', '61-90 days', '90+ days'],
            datasets: [{
                label: 'Outstanding',
                data: [aging['0-30'], aging['31-60'], aging['61-90'], aging['90+']],
                backgroundColor: ['#22c55e', '#f59e0b', '#f97316', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function renderDesktopTable(invoices) {
    const tbody = document.querySelector('#invoices-table tbody');
    const emptyState = document.getElementById('empty-state');

    if (invoices.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    tbody.innerHTML = '';

    invoices.forEach(inv => {
        let statusColor = inv.status === 'paid' ? '#10b981' : inv.status === 'sent' ? 'var(--success)' : 'var(--error)';
        let statusText = inv.status === 'paid' ? (translations[currentLang]['paid'] || 'Paid') : inv.status === 'sent' ? (translations[currentLang]['sent'] || 'Sent') : (translations[currentLang]['draft'] || 'Draft');
        if (!inv.status || inv.status === 'draft') statusText = translations[currentLang]['draft'] || 'Draft';

        const statusBadge = `<span style="padding:6px 14px; border-radius:50px; font-size:12px; font-weight:600; background:${statusColor}; color:white;">${statusText}</span>`;

        const isDraft = (!inv.status || inv.status === 'draft');

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${inv.invoice_id || 'N/A'}</strong></td>
            <td>${inv.issue_date ? new Date(inv.issue_date).toLocaleDateString(currentLang === 'sv' ? 'sv-SE' : 'en-GB') : '‚Äî'}</td>
            <td>${inv.customer_name || '‚Äî'}</td>
            <td><strong>${formatAmount(inv.total_amount)}</strong></td>
            <td>${inv.currency || 'EUR'}</td>
            <td>${statusBadge}</td>
            <td class="actions-cell">
                ${isDraft ? `<button class="action-btn edit-btn" data-id="${inv.id}">${translations[currentLang]['edit'] || 'Edit'}</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn view-btn" data-id="${inv.id}">${translations[currentLang]['view'] || 'View'}</button>` : '<span style="color:var(--text-secondary);font-size:11px;">No XML</span>'}
                ${inv.xml_data ? `<button class="action-btn download-btn" data-id="${inv.id}">${translations[currentLang]['download'] || 'Download'}</button>` : ''}
            </td>
            <td>
                ${isDraft ? `<span class="delete-icon" data-id="${inv.id}" title="${translations[currentLang]['delete_draft'] || 'Delete Draft'}">üóë</span>` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });

    attachActionListeners();
}

function renderMobileCards(invoices) {
    const container = document.getElementById('mobile-invoice-list');
    const emptyState = document.getElementById('empty-state');

    if (invoices.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    container.innerHTML = '';

    invoices.forEach(inv => {
        let statusColor = inv.status === 'paid' ? '#10b981' : inv.status === 'sent' ? 'var(--success)' : 'var(--error)';
        let statusText = inv.status === 'paid' ? (translations[currentLang]['paid'] || 'Paid') : inv.status === 'sent' ? (translations[currentLang]['sent'] || 'Sent') : (translations[currentLang]['draft'] || 'Draft');
        if (!inv.status || inv.status === 'draft') statusText = translations[currentLang]['draft'] || 'Draft';

        const statusBadge = `<span style="padding:8px 16px; border-radius:50px; font-size:14px; font-weight:600; background:${statusColor}; color:white;">${statusText}</span>`;

        const isDraft = (!inv.status || inv.status === 'draft');

        const card = document.createElement('div');
        card.className = 'invoice-card';
        card.innerHTML = `
            <div class="invoice-card-header">
                <div>
                    <strong style="font-size:20px;">${inv.invoice_id || 'N/A'}</strong><br>
                    <span style="color:var(--text-secondary);">${inv.issue_date ? new Date(inv.issue_date).toLocaleDateString(currentLang === 'sv' ? 'sv-SE' : 'en-GB') : '‚Äî'}</span>
                </div>
                ${statusBadge}
            </div>
            <div class="invoice-card-main">
                <div class="invoice-card-label">${translations[currentLang]['customer'] || 'Customer'}</div>
                <div class="invoice-card-value">${inv.customer_name || '‚Äî'}</div>

                <div class="invoice-card-label">${translations[currentLang]['total'] || 'Total'}</div>
                <div class="invoice-card-value"><strong>${formatAmount(inv.total_amount)} ${inv.currency || 'EUR'}</strong></div>
            </div>
            <div class="invoice-card-actions">
                ${isDraft ? `<button class="action-btn edit-btn" data-id="${inv.id}">${translations[currentLang]['edit'] || 'Edit'}</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn view-btn" data-id="${inv.id}">${translations[currentLang]['view'] || 'View'}</button>` : ''}
                ${inv.xml_data ? `<button class="action-btn download-btn" data-id="${inv.id}">${translations[currentLang]['download'] || 'Download'}</button>` : ''}
            </div>
            <div class="delete-cell-mobile">
                ${isDraft ? `<span class="delete-icon" data-id="${inv.id}">${translations[currentLang]['delete'] || 'Delete'}</span>` : ''}
            </div>
        `;
        container.appendChild(card);
    });

    attachActionListeners();
}

function attachActionListeners() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => {
            const invId = btn.dataset.id;
            const inv = allInvoices.find(i => i.id === invId);
            if (!inv) return alert('Invoice not found.');
            let formData = inv.form_data;
            if (typeof formData === 'string') {
                try { formData = JSON.parse(formData); } catch (e) { return alert('Corrupted form data.'); }
            }
            if (formData && typeof formData === 'object' && Object.keys(formData).length > 0) {
                localStorage.setItem('draft_form_data', JSON.stringify(formData));
                localStorage.setItem('editing_draft_id', inv.id);
                window.location.href = 'form.html?mode=edit_draft';
            } else {
                alert('No valid form data found for this draft.');
            }
        };
    });
    document.querySelectorAll('.delete-icon').forEach(icon => {
        icon.onclick = async () => {
            const invId = icon.dataset.id;
            const inv = allInvoices.find(i => i.id === invId);
            if (!confirm(`Are you sure you want to permanently delete draft "${inv.invoice_id || 'N/A'}"? This action cannot be undone.`)) {
                return;
            }
            const { error } = await supabase.from('invoices').delete().eq('id', invId);
            if (error) {
                alert('Failed to delete draft: ' + error.message);
            } else {
                alert('Draft deleted successfully.');
                allInvoices = allInvoices.filter(i => i.id !== invId);
                applyFilters();
            }
        };
    });
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.onclick = () => {
            const inv = allInvoices.find(i => i.id === btn.dataset.id);
            if (inv && inv.xml_data) {
                const blob = new Blob([inv.xml_data], { type: 'application/xml' });
                window.open(URL.createObjectURL(blob), '_blank');
            }
        };
    });
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.onclick = () => {
            const inv = allInvoices.find(i => i.id === btn.dataset.id);
            if (inv && inv.xml_data) {
                const blob = new Blob([inv.xml_data], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${inv.invoice_id || 'invoice'}.xml`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
    });
}

function applyFilters() {
    let filtered = allInvoices;
    const idFilter = document.getElementById('filter-id').value.trim().toLowerCase();
    if (idFilter) filtered = filtered.filter(inv => (inv.invoice_id || '').toLowerCase().includes(idFilter));
    const custFilter = document.getElementById('filter-customer').value.trim().toLowerCase();
    if (custFilter) filtered = filtered.filter(inv => (inv.customer_name || '').toLowerCase().includes(custFilter));
    const fromDate = document.getElementById('filter-from').value;
    if (fromDate) filtered = filtered.filter(inv => inv.issue_date >= fromDate);
    const toDate = document.getElementById('filter-to').value;
    if (toDate) filtered = filtered.filter(inv => inv.issue_date <= toDate);
    const statusFilter = document.getElementById('filter-status').value;
    if (statusFilter) filtered = filtered.filter(inv => (inv.status || 'draft') === statusFilter);
    displayedInvoices = filtered;
    sortAndRender();
    renderAnalytics(filtered);
}

['filter-id', 'filter-customer', 'filter-from', 'filter-to', 'filter-status'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', applyFilters);
        el.addEventListener('change', applyFilters);
    }
});

document.getElementById('clear-filters').addEventListener('click', () => {
    ['filter-id', 'filter-customer', 'filter-from', 'filter-to'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('filter-status').value = '';
    applyFilters();
});

function exportDisplayedToCSV() {
    if (displayedInvoices.length === 0) {
        alert('No invoices currently displayed to export.');
        return;
    }
    let csv = 'Invoice ID,Issue Date,Customer Name,Total Amount,Currency,Status\n';
    displayedInvoices.forEach(inv => {
        const status = inv.status ? inv.status.charAt(0).toUpperCase() + inv.status.slice(1) : 'Draft';
        const customer = (inv.customer_name || '').replace(/"/g, '""');
        csv += `"${inv.invoice_id || ''}","${inv.issue_date || ''}","${customer}","${inv.total_amount || '0.00'}","${inv.currency || 'EUR'}","${status}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `invoices_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ae72f4a2b8f9939',t:'MTc2NTgxNDc1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>